"""Flask API ì„œë²„: í”„ë¡ íŠ¸ì—”ë“œì™€ Gemini AIë¥¼ ì—°ê²°í•©ë‹ˆë‹¤."""

from __future__ import annotations

import logging
from typing import Dict, Any

from flask import Flask, request, jsonify
from flask_cors import CORS

from ai_core.config import Settings
from ai_core.strict_chat import StrictGeminiMusicChat as GeminiMusicChat
from ai_core.recommendation_service import RecommendationService
from ai_core.spotify_client import SpotifyClient, SpotifyAuthError


# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)
CORS(app)  # ëª¨ë“  origin í—ˆìš© (ê°œë°œ í™˜ê²½)

# ì „ì—­ ì„¤ì • ë° ì¸ìŠ¤í„´ìŠ¤
settings = Settings.from_env()
chat = GeminiMusicChat(api_key=settings.gemini_api_key, model_name=settings.gemini_model)
spotify_client = SpotifyClient(settings)
recommendation_service = RecommendationService(
    spotify_client,
    default_limit=5,
    market=settings.spotify_market,
)

# ì„¸ì…˜ë³„ ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë”•ì…”ë„ˆë¦¬ (ê°„ë‹¨í•œ êµ¬í˜„)
# ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” Redis ë“±ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤
chat_sessions: Dict[str, GeminiMusicChat] = {}


@app.route('/api/health', methods=['GET'])
def health_check():
    """ì„œë²„ ìƒíƒœ í™•ì¸"""
    return jsonify({"status": "ok", "message": "AI server is running"})


@app.route('/api/chat', methods=['POST'])
def chat_endpoint():
    """
    í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë°›ì•„ Geminiì— ì „ë‹¬í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    Request Body:
    {
        "message": "ì‚¬ìš©ì ë©”ì‹œì§€",
        "session_id": "ì„¸ì…˜ ID (ì„ íƒì‚¬í•­)"
    }
    
    Response:
    {
        "type": "conversation" | "analysis_complete" | "error",
        "message": "AI ì‘ë‹µ ë©”ì‹œì§€",
        "recommendations": [...] (ë¶„ì„ ì™„ë£Œ ì‹œì—ë§Œ í¬í•¨)
    }
    """
    try:
        data = request.get_json()
        
        if not data or 'message' not in data:
            return jsonify({
                "type": "error",
                "message": "ë©”ì‹œì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤."
            }), 400
        
        user_message = data['message']
        session_id = data.get('session_id', 'default')
        
        # ì„¸ì…˜ë³„ ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©)
        current_chat = chat_sessions.get(session_id, chat)
        
        logger.info(f"[Session: {session_id}] User message: {user_message}")
        
        # Geminiì— ë©”ì‹œì§€ ì „ì†¡
        gemini_response = current_chat.send_message(user_message)
        
        response_data = {
            "type": gemini_response.type,
            "message": gemini_response.message,
        }
        
        # ë¶„ì„ì´ ì™„ë£Œëœ ê²½ìš° Spotify ì¶”ì²œ ìƒì„±
        if gemini_response.type == "analysis_complete" and gemini_response.target_features:
            try:
                recommendation_result = recommendation_service.recommend(
                    target_features=gemini_response.target_features,
                    genres=gemini_response.genres,
                    seed_artists=None,
                )
                
                payload = recommendation_service.build_backend_payload(recommendation_result)
                response_data["recommendations"] = payload
                
                logger.info(f"[Session: {session_id}] Generated {len(payload.get('tracks', []))} recommendations")
                
            except SpotifyAuthError as exc:
                logger.error(f"Spotify auth error: {exc}")
                response_data["message"] += "\n\nâš ï¸ Spotify ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            except Exception as exc:
                logger.error(f"Recommendation error: {exc}")
                response_data["message"] += "\n\nâš ï¸ ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        
        return jsonify(response_data), 200
        
    except Exception as e:
        logger.exception(f"Error in chat endpoint: {e}")
        return jsonify({
            "type": "error",
            "message": "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        }), 500


@app.route('/api/chat/reset', methods=['POST'])
def reset_chat():
    """
    ì±„íŒ… ì„¸ì…˜ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    
    Request Body:
    {
        "session_id": "ì„¸ì…˜ ID (ì„ íƒì‚¬í•­)"
    }
    """
    try:
        data = request.get_json() or {}
        session_id = data.get('session_id', 'default')
        
        if session_id in chat_sessions:
            chat_sessions[session_id].reset()
        else:
            chat.reset()
        
        logger.info(f"[Session: {session_id}] Chat reset")
        
        return jsonify({
            "status": "ok",
            "message": "ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
        }), 200
        
    except Exception as e:
        logger.exception(f"Error in reset endpoint: {e}")
        return jsonify({
            "type": "error",
            "message": "ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        }), 500


if __name__ == '__main__':
    print("=" * 60)
    print("ğŸš€ AI API ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    print("ğŸ“ ì„œë²„ ì£¼ì†Œ: http://localhost:5000")
    print("ğŸ“ Health check: http://localhost:5000/api/health")
    print("ğŸ“ Chat endpoint: POST http://localhost:5000/api/chat")
    print("=" * 60)
    
    app.run(host='0.0.0.0', port=5000, debug=True)
